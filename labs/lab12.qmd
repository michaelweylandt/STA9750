---
title: "{{< var course.short >}} Week 12 In-Class Activity: Strings"
engine: knitr
format: live-html
---

{{< include _gradethis_init.qmd >}}

# [Slides](../slides/slides12.qmd)

# Review and Warm-Up {#review}

*Redux of [Exercise 03 from Last Week](./lab11.html#ex03)*


[Hadley Wickham](https://hadley.nz/) is the author of many of the 
"tidy tools" we use in this course. He is also an excellent bartender
and chef. In this exercise, we are going to web scrape his cocktail
recipe book which can be found at <https://cocktails.hadley.nz/>. 

Our goal is to create a data frame that records all 150+ recipes on this site 
(as rows) and the different ingredients (as columns). This
week, we are going to pull the different recipes into `R`: next week
we are going to process the text and create our final data frame (so
stay tuned!). 

Working with your project team, first go through the following steps to build
a scraping strategy:

1) Poke around the website to see how it is organized. Is there a
   single page listing all of the cocktails? If not, how else can
   you make sure that you've explored the entire site?
2) Once you know how you're going to explore the whole site, use
   your browser tools to see if you can identify an HTML element that
   corresponds to a single recipe. (This element will occur several
   times per page) Remember that you want to select "as small as
   possible" but no smaller.
3) Once you have found the right HTML element for a recipe, identify
   an HTML element that corresponds to i) the title; and ii) individual
   ingredients. 
   
For this task, you will likely see several recipes more than once.
Don't worry about this for now - we can `distinct` out the duplicates
later in our analysis. It's better to be over-inclusive than
under-inclusive.
   
After you have built your plan, it's time to start putting this all to
code. 

1) Write code to get a list of all pages you will need to process. Construct 
   full URLs for your future requests. 
   
::: {.callout-tip title="Solution" collapse="true"}

```{r}
#| cache: true
library(tidyverse)
library(httr2)
library(rvest)

BASE_URL <- "https://cocktails.hadley.nz/"

PAGES <- read_html(BASE_URL) |> 
            html_elements("nav a") |> 
            html_attr("href")

PAGE_URLS <- paste0(BASE_URL, PAGES)


PAGE_URLS
```

:::

2) Write a function that takes a single URL and extracts all recipes on that
   page as HTML elements. 
   
   Try this out on a fixed URL and confirm that it gets the right number of
   recipes

::: {.callout-tip title="Solution" collapse="true"}

```{r}
library(tidyverse)
library(httr2)
library(rvest)
get_recipes <- function(url){
    read_html(url) |> html_elements("article")
}
```   

We can test this [against this page](https://cocktails.hadley.nz/tag-bubbles.html)
and see that it works as expected: 

```{r}
BUBBLES <- get_recipes("https://cocktails.hadley.nz/tag-bubbles.html")

BUBBLES
```

:::

3) Write a function that takes in a single recipe and returns a small data 
   frame with the title and ingredients: 
   
::: {.callout-tip title="Solution" collapse="true"}

```{r}
library(tidyverse)
library(httr2)
library(rvest)
process_recipe <- function(art){
    title <- art |> html_element(".title") |> html_text2()
    ingredients <- art |> html_elements("li") |> html_text2()
    
    tibble(title=title, ingredients=ingredients)
}
```  

We can again test this using the recipes we extracted above: 

```{r}
process_recipe(BUBBLES[[1]])
```

:::

4) Write a function that combines your results from the previous two steps to
   build a data frame with _all_ recipes on a single page. 
   
   Try this out on a fixed URL and confirm it works as expected. 
   
::: {.callout-tip title="Solution" collapse="true"}

```{r}
library(tidyverse)
library(httr2)
library(rvest)

process_url <- function(url){
    html_recipes <- get_recipes(url)
    
    RECIPES <- data.frame()
    
    for(r in html_recipes){
        RECIPES <- rbind(RECIPES, process_recipe(r))
    }
    
    RECIPES
}
```

We can test this on the page of bubbly recipes: 

```{r}
process_url("https://cocktails.hadley.nz/tag-bubbles.html")
```

:::
   
5) Use your function from the first step with the list of URLs from Step 1 so
   that you get all of the recipes on the site. Combine your results into one
   large data frame that looks something like:
   
   | Name     | Ingredient           |
   |----------|----------------------|
   | Daiquiri | 2 oz Rum             | 
   | Daiquiri | 1 oz Lime Juice      | 
   | Daiquiri | 0.75 oz Simple Syrup |

   To be polite, you may want to add `req_cache` to your requests so you are not
   requesting the same page many times over. 
   
::: {.callout-tip title="Solution" collapse="true"}

```{r}
library(tidyverse)
library(httr2)
library(rvest)

ALL_RECIPES <- data.frame()

for(page in PAGE_URLS){
    ALL_RECIPES <- rbind(ALL_RECIPES, process_url(page))
}

ALL_RECIPES
```

:::




::: {.callout-caution title="FP Solution" collapse="true"}

If you are comfortable with (or want to become comfortable with) the functional
programming tools of `purrr`, you can write this entire analysis in one swoop:

```{r}
#| cache: true
library(tidyverse)
library(rvest)
process_recipe <- function(recipe){
    title <- recipe |> html_element(".title") |> html_text2()
    ingredients <- recipe |> html_elements("li") |> html_text2()
    
    tibble(title=title, ingredients=ingredients)
}

BASE_URL <- "https://cocktails.hadley.nz/"

read_html(BASE_URL) |> 
    html_elements("nav a") |> 
    html_attr("href") |>
    map(\(p) request(BASE_URL) |> req_url_path(p)) |>
    map(req_perform) |>
    map(resp_body_html) |> 
    map(html_elements, "article") |> 
    reduce(c) |>
    map(process_recipe) |> 
    list_rbind()
```

This is clearly quite terse and would benefit from some additional comments,
but I'm omitting them so you can try to deconstruct this code yourself if 
you want to practice functional programming idioms. 

:::

At this point, we're _almost_ done, but we would really like to transform
a table like: 

   | Name     | Ingredient           |
   |----------|----------------------|
   | Daiquiri | 2 oz Rum             | 
   | Daiquiri | 1 oz Lime Juice      | 
   | Daiquiri | 0.75 oz Simple Syrup |
   
into 

   | Name     | Ingredient   | Amount  |
   |----------|--------------|---------|
   | Daiquiri | Rum          | 2       |
   | Daiquiri | Lime Juice   | 1       |
   | Daiquiri | Simple Syrup | 0.75    |

by splitting the _amount_ (number) from the _ingredient_ (string). This type
of manipulation is the major goal of today's class. 

# Regular Expression Practice {#regex}

Complete the following exercises using functionality from the
`stringr` package. 

1. In the following sentence, extract all *plural nouns*[^1]:

```{r}
#| eval: false
todo <- "Yesterday, I needed to buy four cups of flour, a piece of Parmesan cheese, two gallons of ice cream, and a six-pack of bottled (non-alcoholic) beers."
```

```{webr}
#| exercise: plural_nouns
library(stringr)
todo <- "Yesterday, I needed to buy four cups of flour, a piece of Parmesan cheese, two gallons of ice cream, and a six-pack of bottled (non-alcoholic) beers."
str_extract_all(todo, ______, simplify=TRUE)
```


::: {.solution exercise="plural_nouns"}

```{webr}
#| exercise: plural_nouns
#| solution: true
library(stringr)
todo <- "Yesterday, I needed to buy four cups of flour, a piece of Parmesan cheese, two gallons of ice cream, and a six-pack of bottled (non-alcoholic) beers."
str_extract_all(todo, " [A-Za-z]+s[., ]", simplify=TRUE)
```

If you recall character classes from the pre-assignment, this can also be written as: 

```{webr}
library(stringr)
todo <- "Yesterday, I needed to buy four cups of flour, a piece of Parmesan cheese, two gallons of ice cream, and a six-pack of bottled (non-alcoholic) beers."
str_extract_all(todo, "\\w+s\\W", simplify=TRUE)
```

or, if we want to trim the whitespace and punctuation: 

```{webr}
library(stringr)
todo <- "Yesterday, I needed to buy four cups of flour, a piece of Parmesan cheese, two gallons of ice cream, and a six-pack of bottled (non-alcoholic) beers."
str_match_all(todo, " (\\w+s)\\W")
```

This gives back our answer in a slightly weird
format - a list of string matrices - but it will suffice for now.

:::

```{webr}
#| exercise: plural_nouns
#| check: true
library(stringr)
gradethis::grade_this_code()
```


[^1]: While English pluralization rules are tricky, you can just find the words 
ending with an `s`.

2. In the following sentence, compute the total number of fruits on my shopping
list: 

```{r}
#| eval: false
shopping <- "Today, I need to purchase 3 apples, 5 limes, and 2 lemons."
```

```{webr}
#| exercise: numbers
library(stringr)
shopping <- "Today, I need to purchase 3 apples, 5 limes, and 2 lemons."
sum(as.numeric(str_extract_all(shopping, ______, simplify=TRUE)))
```

::: {.solution exercise="numbers"}

```{webr}
#| exercise: numbers
#| solution: true
library(stringr)
shopping <- "Today, I need to purchase 3 apples, 5 limes, and 2 lemons."
sum(as.numeric(str_extract_all(shopping, "\\d+", simplify=TRUE)))
```
:::

```{webr}
#| exercise: numbers
#| check: true
library(stringr)
gradethis::grade_this_code()
```

3. The following text is adapted from the 
[Taylor Swift wikipedia page](https://en.wikipedia.org/wiki/Taylor_Swift), 
with some changes made to the punctuation to make things easier. 

> Taylor Alison Swift (born December 13, 1989) is an American singer-songwriter. A subject of widespread public interest, she has influenced the music industry and popular culture through her artistry, especially in songwriting, and entrepreneurship. She is an advocate of artists rights and womens empowerment. Swift began professional songwriting at age 14. She signed with Big Machine Records in 2005 and achieved prominence as a country pop singer with the albums Taylor Swift (2006) and Fearless (2008). Their singles 'Teardrops on My Guitar', 'Love Story', and 'You Belong with Me' were crossover successes on country and pop radio formats and brought Swift mainstream fame. She experimented with rock and electronic styles on her next albums, Speak Now (2010) and Red (2012), respectively, with the latter featuring her first Billboard Hot 100 number-one single, 'We Are Never Ever Getting Back Together'. Swift recalibrated her image from country to pop with 1989 (2014), a synth-pop album containing the chart-topping songs 'Shake It Off', 'Blank Space', and 'Bad Blood'. Media scrutiny inspired the hip-hop-influenced Reputation (2017) and its number-one single 'Look What You Made Me Do'. After signing with Republic Records in 2018, Swift released the eclectic pop album Lover (2019) and the autobiographical documentary Miss Americana (2020). She explored indie folk styles on the 2020 albums Folklore and Evermore, subdued electropop on Midnights (2022), and re-recorded four albums subtitled Taylors Version after a dispute with Big Machine. These albums spawned the number-one songs 'Cruel Summer', 'Cardigan', 'Willow', 'Anti-Hero', 'All Too Well', and 'Is It Over Now?'. Her Eras Tour (2023-2024) and its accompanying concert film became the highest-grossing tour and concert film of all time, respectively. Swift has directed videos and films such as Folklore: The Long Pond Studio Sessions (2020) and All Too Well: The Short Film (2021). Swift is one of the worlds best-selling artists, with 200 million records sold worldwide as of 2019. She is the most-streamed artist on Spotify, the highest-grossing female touring act, and the first billionaire with music as the main source of income. Six of her albums have opened with over one million sales in a week. The 2023 Time Person of the Year, Swift has appeared on lists such as Rolling Stones 100 Greatest Songwriters of All Time, Billboards Greatest of All Time Artists, and Forbes Worlds 100 Most Powerful Women. Her accolades include 14 Grammy Awards, a Primetime Emmy Award,  40 American Music Awards, 39 Billboard Music Awards, and 23 MTV Video Music Awards; she has won the Grammy Award for Album of the Year, the MTV Video Music Award for Video of the Year, and the IFPI Global Recording Artist of the Year a record four times each.

How many times does Taylor Swift's last name appear? 

```{webr}
#| exercise: swift
library(stringr)
swift <- "Taylor Alison Swift (born December 13, 1989) is an American singer-songwriter. A subject of widespread public interest, she has influenced the music industry and popular culture through her artistry, especially in songwriting, and entrepreneurship. She is an advocate of artists rights and womens empowerment. Swift began professional songwriting at age 14. She signed with Big Machine Records in 2005 and achieved prominence as a country pop singer with the albums Taylor Swift (2006) and Fearless (2008). Their singles 'Teardrops on My Guitar', 'Love Story', and 'You Belong with Me' were crossover successes on country and pop radio formats and brought Swift mainstream fame. She experimented with rock and electronic styles on her next albums, Speak Now (2010) and Red (2012), respectively, with the latter featuring her first Billboard Hot 100 number-one single, 'We Are Never Ever Getting Back Together'. Swift recalibrated her image from country to pop with 1989 (2014), a synth-pop album containing the chart-topping songs 'Shake It Off', 'Blank Space', and 'Bad Blood'. Media scrutiny inspired the hip-hop-influenced Reputation (2017) and its number-one single 'Look What You Made Me Do'. After signing with Republic Records in 2018, Swift released the eclectic pop album Lover (2019) and the autobiographical documentary Miss Americana (2020). She explored indie folk styles on the 2020 albums Folklore and Evermore, subdued electropop on Midnights (2022), and re-recorded four albums subtitled Taylors Version after a dispute with Big Machine. These albums spawned the number-one songs 'Cruel Summer', 'Cardigan', 'Willow', 'Anti-Hero', 'All Too Well', and 'Is It Over Now?'. Her Eras Tour (2023-2024) and its accompanying concert film became the highest-grossing tour and concert film of all time, respectively. Swift has directed videos and films such as Folklore: The Long Pond Studio Sessions (2020) and All Too Well: The Short Film (2021). Swift is one of the worlds best-selling artists, with 200 million records sold worldwide as of 2019. She is the most-streamed artist on Spotify, the highest-grossing female touring act, and the first billionaire with music as the main source of income. Six of her albums have opened with over one million sales in a week. The 2023 Time Person of the Year, Swift has appeared on lists such as Rolling Stones 100 Greatest Songwriters of All Time, Billboards Greatest of All Time Artists, and Forbes Worlds 100 Most Powerful Women. Her accolades include 14 Grammy Awards, a Primetime Emmy Award,  40 American Music Awards, 39 Billboard Music Awards, and 23 MTV Video Music Awards; she has won the Grammy Award for Album of the Year, the MTV Video Music Award for Video of the Year, and the IFPI Global Recording Artist of the Year a record four times each."
str_count(swift, ______)
```

::: {.solution exercise="swift"}

```{webr}
#| exercise: swift
#| solution: true
library(stringr)
swift <- "Taylor Alison Swift (born December 13, 1989) is an American singer-songwriter. A subject of widespread public interest, she has influenced the music industry and popular culture through her artistry, especially in songwriting, and entrepreneurship. She is an advocate of artists rights and womens empowerment. Swift began professional songwriting at age 14. She signed with Big Machine Records in 2005 and achieved prominence as a country pop singer with the albums Taylor Swift (2006) and Fearless (2008). Their singles 'Teardrops on My Guitar', 'Love Story', and 'You Belong with Me' were crossover successes on country and pop radio formats and brought Swift mainstream fame. She experimented with rock and electronic styles on her next albums, Speak Now (2010) and Red (2012), respectively, with the latter featuring her first Billboard Hot 100 number-one single, 'We Are Never Ever Getting Back Together'. Swift recalibrated her image from country to pop with 1989 (2014), a synth-pop album containing the chart-topping songs 'Shake It Off', 'Blank Space', and 'Bad Blood'. Media scrutiny inspired the hip-hop-influenced Reputation (2017) and its number-one single 'Look What You Made Me Do'. After signing with Republic Records in 2018, Swift released the eclectic pop album Lover (2019) and the autobiographical documentary Miss Americana (2020). She explored indie folk styles on the 2020 albums Folklore and Evermore, subdued electropop on Midnights (2022), and re-recorded four albums subtitled Taylors Version after a dispute with Big Machine. These albums spawned the number-one songs 'Cruel Summer', 'Cardigan', 'Willow', 'Anti-Hero', 'All Too Well', and 'Is It Over Now?'. Her Eras Tour (2023-2024) and its accompanying concert film became the highest-grossing tour and concert film of all time, respectively. Swift has directed videos and films such as Folklore: The Long Pond Studio Sessions (2020) and All Too Well: The Short Film (2021). Swift is one of the worlds best-selling artists, with 200 million records sold worldwide as of 2019. She is the most-streamed artist on Spotify, the highest-grossing female touring act, and the first billionaire with music as the main source of income. Six of her albums have opened with over one million sales in a week. The 2023 Time Person of the Year, Swift has appeared on lists such as Rolling Stones 100 Greatest Songwriters of All Time, Billboards Greatest of All Time Artists, and Forbes Worlds 100 Most Powerful Women. Her accolades include 14 Grammy Awards, a Primetime Emmy Award,  40 American Music Awards, 39 Billboard Music Awards, and 23 MTV Video Music Awards; she has won the Grammy Award for Album of the Year, the MTV Video Music Award for Video of the Year, and the IFPI Global Recording Artist of the Year a record four times each."
str_count(swift, "Swift")
```
:::

```{webr}
#| exercise: swift
#| check: true
library(stringr)
gradethis::grade_this_code()
```


4. In the above quote, how many *different years* (strings of exactly 4 digits)
   appear?
   
```{webr}
#| exercise: years
library(stringr)
swift <- "Taylor Alison Swift (born December 13, 1989) is an American singer-songwriter. A subject of widespread public interest, she has influenced the music industry and popular culture through her artistry, especially in songwriting, and entrepreneurship. She is an advocate of artists rights and womens empowerment. Swift began professional songwriting at age 14. She signed with Big Machine Records in 2005 and achieved prominence as a country pop singer with the albums Taylor Swift (2006) and Fearless (2008). Their singles 'Teardrops on My Guitar', 'Love Story', and 'You Belong with Me' were crossover successes on country and pop radio formats and brought Swift mainstream fame. She experimented with rock and electronic styles on her next albums, Speak Now (2010) and Red (2012), respectively, with the latter featuring her first Billboard Hot 100 number-one single, 'We Are Never Ever Getting Back Together'. Swift recalibrated her image from country to pop with 1989 (2014), a synth-pop album containing the chart-topping songs 'Shake It Off', 'Blank Space', and 'Bad Blood'. Media scrutiny inspired the hip-hop-influenced Reputation (2017) and its number-one single 'Look What You Made Me Do'. After signing with Republic Records in 2018, Swift released the eclectic pop album Lover (2019) and the autobiographical documentary Miss Americana (2020). She explored indie folk styles on the 2020 albums Folklore and Evermore, subdued electropop on Midnights (2022), and re-recorded four albums subtitled Taylors Version after a dispute with Big Machine. These albums spawned the number-one songs 'Cruel Summer', 'Cardigan', 'Willow', 'Anti-Hero', 'All Too Well', and 'Is It Over Now?'. Her Eras Tour (2023-2024) and its accompanying concert film became the highest-grossing tour and concert film of all time, respectively. Swift has directed videos and films such as Folklore: The Long Pond Studio Sessions (2020) and All Too Well: The Short Film (2021). Swift is one of the worlds best-selling artists, with 200 million records sold worldwide as of 2019. She is the most-streamed artist on Spotify, the highest-grossing female touring act, and the first billionaire with music as the main source of income. Six of her albums have opened with over one million sales in a week. The 2023 Time Person of the Year, Swift has appeared on lists such as Rolling Stones 100 Greatest Songwriters of All Time, Billboards Greatest of All Time Artists, and Forbes Worlds 100 Most Powerful Women. Her accolades include 14 Grammy Awards, a Primetime Emmy Award,  40 American Music Awards, 39 Billboard Music Awards, and 23 MTV Video Music Awards; she has won the Grammy Award for Album of the Year, the MTV Video Music Award for Video of the Year, and the IFPI Global Recording Artist of the Year a record four times each."
str_count(swift, ______)
```

::: {.solution exercise="years"}

```{webr}
#| exercise: years
#| solution: true
library(stringr)
swift <- "Taylor Alison Swift (born December 13, 1989) is an American singer-songwriter. A subject of widespread public interest, she has influenced the music industry and popular culture through her artistry, especially in songwriting, and entrepreneurship. She is an advocate of artists rights and womens empowerment. Swift began professional songwriting at age 14. She signed with Big Machine Records in 2005 and achieved prominence as a country pop singer with the albums Taylor Swift (2006) and Fearless (2008). Their singles 'Teardrops on My Guitar', 'Love Story', and 'You Belong with Me' were crossover successes on country and pop radio formats and brought Swift mainstream fame. She experimented with rock and electronic styles on her next albums, Speak Now (2010) and Red (2012), respectively, with the latter featuring her first Billboard Hot 100 number-one single, 'We Are Never Ever Getting Back Together'. Swift recalibrated her image from country to pop with 1989 (2014), a synth-pop album containing the chart-topping songs 'Shake It Off', 'Blank Space', and 'Bad Blood'. Media scrutiny inspired the hip-hop-influenced Reputation (2017) and its number-one single 'Look What You Made Me Do'. After signing with Republic Records in 2018, Swift released the eclectic pop album Lover (2019) and the autobiographical documentary Miss Americana (2020). She explored indie folk styles on the 2020 albums Folklore and Evermore, subdued electropop on Midnights (2022), and re-recorded four albums subtitled Taylors Version after a dispute with Big Machine. These albums spawned the number-one songs 'Cruel Summer', 'Cardigan', 'Willow', 'Anti-Hero', 'All Too Well', and 'Is It Over Now?'. Her Eras Tour (2023-2024) and its accompanying concert film became the highest-grossing tour and concert film of all time, respectively. Swift has directed videos and films such as Folklore: The Long Pond Studio Sessions (2020) and All Too Well: The Short Film (2021). Swift is one of the worlds best-selling artists, with 200 million records sold worldwide as of 2019. She is the most-streamed artist on Spotify, the highest-grossing female touring act, and the first billionaire with music as the main source of income. Six of her albums have opened with over one million sales in a week. The 2023 Time Person of the Year, Swift has appeared on lists such as Rolling Stones 100 Greatest Songwriters of All Time, Billboards Greatest of All Time Artists, and Forbes Worlds 100 Most Powerful Women. Her accolades include 14 Grammy Awards, a Primetime Emmy Award,  40 American Music Awards, 39 Billboard Music Awards, and 23 MTV Video Music Awards; she has won the Grammy Award for Album of the Year, the MTV Video Music Award for Video of the Year, and the IFPI Global Recording Artist of the Year a record four times each."
str_count(swift, "\\d{4}")
```
:::

```{webr}
#| exercise: years
#| check: true
library(stringr)
gradethis::grade_this_code()
```

5. Extract the names of all songs mentioned in the biography above. (Note 
   that song names are surrounded by single quotes.)

   You will need to use a [_lazy_ regular expression](https://stringr.tidyverse.org/articles/regular-expressions.html#repetition). 
   
   
```{webr}
#| exercise: albums
library(stringr)
swift <- "Taylor Alison Swift (born December 13, 1989) is an American singer-songwriter. A subject of widespread public interest, she has influenced the music industry and popular culture through her artistry, especially in songwriting, and entrepreneurship. She is an advocate of artists rights and womens empowerment. Swift began professional songwriting at age 14. She signed with Big Machine Records in 2005 and achieved prominence as a country pop singer with the albums Taylor Swift (2006) and Fearless (2008). Their singles 'Teardrops on My Guitar', 'Love Story', and 'You Belong with Me' were crossover successes on country and pop radio formats and brought Swift mainstream fame. She experimented with rock and electronic styles on her next albums, Speak Now (2010) and Red (2012), respectively, with the latter featuring her first Billboard Hot 100 number-one single, 'We Are Never Ever Getting Back Together'. Swift recalibrated her image from country to pop with 1989 (2014), a synth-pop album containing the chart-topping songs 'Shake It Off', 'Blank Space', and 'Bad Blood'. Media scrutiny inspired the hip-hop-influenced Reputation (2017) and its number-one single 'Look What You Made Me Do'. After signing with Republic Records in 2018, Swift released the eclectic pop album Lover (2019) and the autobiographical documentary Miss Americana (2020). She explored indie folk styles on the 2020 albums Folklore and Evermore, subdued electropop on Midnights (2022), and re-recorded four albums subtitled Taylors Version after a dispute with Big Machine. These albums spawned the number-one songs 'Cruel Summer', 'Cardigan', 'Willow', 'Anti-Hero', 'All Too Well', and 'Is It Over Now?'. Her Eras Tour (2023-2024) and its accompanying concert film became the highest-grossing tour and concert film of all time, respectively. Swift has directed videos and films such as Folklore: The Long Pond Studio Sessions (2020) and All Too Well: The Short Film (2021). Swift is one of the worlds best-selling artists, with 200 million records sold worldwide as of 2019. She is the most-streamed artist on Spotify, the highest-grossing female touring act, and the first billionaire with music as the main source of income. Six of her albums have opened with over one million sales in a week. The 2023 Time Person of the Year, Swift has appeared on lists such as Rolling Stones 100 Greatest Songwriters of All Time, Billboards Greatest of All Time Artists, and Forbes Worlds 100 Most Powerful Women. Her accolades include 14 Grammy Awards, a Primetime Emmy Award,  40 American Music Awards, 39 Billboard Music Awards, and 23 MTV Video Music Awards; she has won the Grammy Award for Album of the Year, the MTV Video Music Award for Video of the Year, and the IFPI Global Recording Artist of the Year a record four times each."
str_extract_all(swift, ______, simplify=TRUE)
```

::: {.solution exercise="albums"}

```{webr}
#| exercise: albums
#| solution: true
library(stringr)
swift <- "Taylor Alison Swift (born December 13, 1989) is an American singer-songwriter. A subject of widespread public interest, she has influenced the music industry and popular culture through her artistry, especially in songwriting, and entrepreneurship. She is an advocate of artists rights and womens empowerment. Swift began professional songwriting at age 14. She signed with Big Machine Records in 2005 and achieved prominence as a country pop singer with the albums Taylor Swift (2006) and Fearless (2008). Their singles 'Teardrops on My Guitar', 'Love Story', and 'You Belong with Me' were crossover successes on country and pop radio formats and brought Swift mainstream fame. She experimented with rock and electronic styles on her next albums, Speak Now (2010) and Red (2012), respectively, with the latter featuring her first Billboard Hot 100 number-one single, 'We Are Never Ever Getting Back Together'. Swift recalibrated her image from country to pop with 1989 (2014), a synth-pop album containing the chart-topping songs 'Shake It Off', 'Blank Space', and 'Bad Blood'. Media scrutiny inspired the hip-hop-influenced Reputation (2017) and its number-one single 'Look What You Made Me Do'. After signing with Republic Records in 2018, Swift released the eclectic pop album Lover (2019) and the autobiographical documentary Miss Americana (2020). She explored indie folk styles on the 2020 albums Folklore and Evermore, subdued electropop on Midnights (2022), and re-recorded four albums subtitled Taylors Version after a dispute with Big Machine. These albums spawned the number-one songs 'Cruel Summer', 'Cardigan', 'Willow', 'Anti-Hero', 'All Too Well', and 'Is It Over Now?'. Her Eras Tour (2023-2024) and its accompanying concert film became the highest-grossing tour and concert film of all time, respectively. Swift has directed videos and films such as Folklore: The Long Pond Studio Sessions (2020) and All Too Well: The Short Film (2021). Swift is one of the worlds best-selling artists, with 200 million records sold worldwide as of 2019. She is the most-streamed artist on Spotify, the highest-grossing female touring act, and the first billionaire with music as the main source of income. Six of her albums have opened with over one million sales in a week. The 2023 Time Person of the Year, Swift has appeared on lists such as Rolling Stones 100 Greatest Songwriters of All Time, Billboards Greatest of All Time Artists, and Forbes Worlds 100 Most Powerful Women. Her accolades include 14 Grammy Awards, a Primetime Emmy Award,  40 American Music Awards, 39 Billboard Music Awards, and 23 MTV Video Music Awards; she has won the Grammy Award for Album of the Year, the MTV Video Music Award for Video of the Year, and the IFPI Global Recording Artist of the Year a record four times each."
str_extract_all(swift, "'.*?'", simplify=TRUE)
```
:::

```{webr}
#| exercise: albums
#| check: true
library(stringr)
gradethis::grade_this_code()
```

# Scraping Practice I: Cocktails {#cocktails_finish}

Last week, we began to scrape [Hadley's Cocktails](https://cocktails.hadley.nz/)
with an (eventual) goal of creating a "spreadsheet" of recipes by ingredients.

We found the following: 

```{r}
#| cache: true
library(rvest)
BASE_URL <- "https://cocktails.hadley.nz/"

PAGES <- read_html(BASE_URL) |> 
    html_elements("nav a") |> 
    html_attr("href")

read_article <- function(article){
    title <- article |> html_element("h2") |> html_text()
    ingredients <- article |> html_elements("li") |> html_text()
    
    data.frame(title=title, ingredient=ingredients)
}

read_page <- function(stub){
    URL <- paste0(BASE_URL, stub)
    COCKTAILS <- read_html(URL) |> html_elements("article")
    
    map(COCKTAILS, read_article) |> list_rbind()
}

RECIPES_LONG <- map(PAGES, read_page) |> list_rbind()
```

Take this output and use `stringr` and `tidyr` to complete the transition to
a well-formatted "wide" set of recipes. 

1. Clean up the `title` column using `str_trim` and remove duplicate rows: 

::: {.callout-tip title="Solution" collapse="true"}

```{r}
RECIPES_LONG <- RECIPES_LONG |>
    mutate(title = str_trim(title)) |>
    distinct()
```

:::

2. Split the `ingredient` column into three new columns: 

   - Amount 
   - Unit
   - Ingredient Name
   
    We will approach this in three steps: 
   
      A. First, write a function to pull out the "unit" (oz, dash, leaves) *etc.*
   
      The units found in this data are `oz`, `dash`, `drop`, `t`, `chunk`, 
      `leaves`, and `cm`. 
      
      *Hint*: Use a `str_extract` and make sure to require a space before and 
      after the unit so you don't pick up `t`s in the names of ingredients.
      
::: {.callout-tip title="Solution" collapse="true"}

    ```{r}
    RECIPES_LONG <- RECIPES_LONG |>
        mutate(unit = str_extract(ingredient, 
                                  " (oz|dash|drop|t|chunk|leaves|cm) ", 
                                  group=1))
    ```

:::

    B. Next, pull out the "number" part at the beginning of each ingredient.
       Note that some fractional amounts are included, so the following function
       may be useful: 
         
    
```{r}
    standardize_number <- function(x){
        library(stringr)
        x |> str_replace("(\\d)½", "\\1.5") |> 
             str_replace("½", "0.5") |>
             str_replace("(\\d)¾", "\\1.75") |> 
             str_replace("¾", "0.75") |>
             str_replace("(\\d)¼", "\\1.25") |> 
            str_replace("¼", "0.25")
    }

    x <- c("½ oz allspice liqueur", "¾ oz Campari", "1¾ oz gin")
    standardize_number(x)
```

::: {.callout-tip title="Solution" collapse="true"}
    
```{r}
RECIPES_LONG <- RECIPES_LONG |>
    mutate(std_ingredient = standardize_number(ingredient), 
           number = str_extract(std_ingredient, "(^[.[:digit:]]+) ", group=1), 
           number = as.double(number)) |> 
    select(-ingredient)
```
    
:::


    C. Finally, everything that you haven't already extracted can be assumed to
       be the name of an ingredient. Use `str_remove` twice to get the ingredient
       names. 
       
::: {.callout-tip title="Solution" collapse="true"}

```{r}
RECIPES_LONG <- RECIPES_LONG |>
    mutate(ingredient = std_ingredient |> 
               str_remove(as.character(number)) |>  # temporarily return to string
               str_remove(unit) |> 
               str_trim()) |>
    select(-std_ingredient)
```

:::   
   
   You should wind up with a table that looks something like
   
| Cocktail | Ingredient | Unit | Amount |
|----------|------------|------|--------|
| Bachelor | rum, dark  | oz   | 1      |
| Bachelor | Meletti    | oz   | 1      |

3. Combine the ingredient and unit columns so that `Meletti` and ` oz ` in 
   two separate columns becomes `Meletti (oz)` in a single column. 

::: {.callout-tip title="Solution" collapse="true"}

```{r}
RECIPES_LONG <- RECIPES_LONG |>
    mutate(ingredient = paste0(ingredient, " (", unit, ")")) |> 
    select(-unit)
```

:::   
   
4. Use a `pivot_*` function to create a new _wide_ table with each ingredient
   as a column. 
   
   *Hint*: Which `pivot` operation do you want to use here? How should the 
   empty cells be treated? Look at the `values_fill` argument. 
   
   Note that there are some duplicate rows when the same ingredient is used twice
   in a single cocktail. You might want to simply add up the relevant numbers before
   proceeding. 

::: {.callout-tip title="Solution" collapse="true"}

```{r}
RECIPES_LONG |>
    group_by(title, ingredient) |>
    summarize(number = sum((number))) |>
    ungroup() |>
    pivot_wider(names_from = ingredient, values_from=number, values_fill=0)
```

This isn't quite perfect (see some problems with the `NA` values), but it's close.

:::   


Here is a compact solution for the whole exercise: 
   
::: {.callout-tip title="Combined Solution" collapse="true"}

```{r}
#| cache: true
library(tidyverse)
library(rvest)
process_recipe <- function(recipe){
    title <- recipe |> html_element(".title") |> html_text2()
    ingredients <- recipe |> html_elements("li") |> html_text2()
    
    tibble(title=title, ingredient=ingredients)
}

BASE_URL <- "https://cocktails.hadley.nz/"

RECIPES_LONG <- read_html(BASE_URL) |> 
    html_elements("nav a") |> 
    html_attr("href") |>
    map(\(p) request(BASE_URL) |> req_url_path(p)) |>
    map(req_perform) |>
    map(resp_body_html) |> 
    map(html_elements, "article") |> 
    reduce(c) |>
    map(process_recipe) |> 
    list_rbind()

standardize_number <- function(x){
    library(stringr)
    x |> str_replace("(\\d)½", "\\1.5") |> 
        str_replace("½", "0.5") |>
        str_replace("(\\d)¾", "\\1.75") |> 
        str_replace("¾", "0.75") |>
        str_replace("(\\d)¼", "\\1.25") |> 
        str_replace("¼", "0.25")
}

RECIPES_LONG |>
    # Remove duplicates from import process
    # When we import each ingredient page, we get duplicates
    # as drinks are listed on multiple ingredient pages.
    distinct() |>
    mutate(title  = str_trim(title), 
           std_ingredient = standardize_number(ingredient), 
           amount = str_extract(std_ingredient, "(^[.[:digit:]]+) ", group=1), 
           amount = as.double(amount), 
           unit = str_extract(ingredient, 
                              " (oz|dash|drop|t|chunk|leaves|cm) ", 
                              group=1),
           ingredient = str_remove_all(ingredient, unit), 
           ingredient = str_remove_all(ingredient, as.character(amount)),
           ingredient = str_trim(ingredient)) |>
    # For some ingredients, e.g. a lemon twist, the implied
    # but unstated quantity is 1
    mutate(amount = case_when(
        is.na(amount) ~ 1, 
        TRUE ~ amount), 
        ingredient = str_to_title(ingredient)) |>
    rename(Cocktail = title, 
           Amount = amount, 
           Unit = unit, 
           Ingredient = ingredient) |>
    mutate(Ingredient = case_when(
        is.na(Unit) ~ Ingredient, # Handle unit-less ingredients
        TRUE ~ paste0(Ingredient, " (", Unit, ")"))) |>
    # Spanish Coffee lists orange liqueur twice, so let's 
    # add up repeated ingredients before pivoting.
    # (I think this is the only one)
    group_by(Cocktail, Ingredient) |>
    summarize(Amount = sum(Amount)) |>
    ungroup() |>
    pivot_wider(id_cols = Cocktail, 
                names_from = Ingredient, 
                values_from = Amount, 
                values_fill = 0) |>
    select("Cocktail", sort(tidyselect::peek_vars()))
```

:::

# Scraping Practice II: Quotes {#quotes}

Let's analyze the website [https://quotes.toscrape.com](https://quotes.toscrape.com),
a website designed to practice web-scraping. 

Scrape the contents of that website--note that quotes continue for multiple 
pages--and answer the following questions. You can check most of these "by hand"
but you need to compute your answers in code!

0. How many pages of quotes are on this site? 

   *Hint*: Write code to keep paging until no more "Next" button is present.
   
::: {.callout-tip title="Solution" collapse="true"}

```{r}
library(httr2)
library(rvest)
library(tidyverse)

N_PAGES <- 1
URL <- "https://quotes.toscrape.com/"

repeat{
    missing_next_button <- request(URL) |>
        req_url_path("page", N_PAGES) |>
        req_perform() |>
        resp_body_html() |>
        html_element(".next") |>
        is.na()
    
    if(missing_next_button){
        break
    } else {
        N_PAGES <- N_PAGES + 1
    }
}
```

There are `N_PAGES` pages worth of quotes on this site. 

:::   

1. How many quotes are on this website (all pages)? 

::: {.callout-tip title="Solution" collapse="true"}

```{r}
library(httr2)
library(tidyverse)
library(rvest)

N_TOTAL_QUOTES <- 0

for(page in 1:N_PAGES){
    n_quotes <- request(URL) |>
        req_url_path("page", page) |>
        req_perform() |>
        resp_body_html() |>
        html_elements(".quote") |>
        length()
    
    N_TOTAL_QUOTES <- N_TOTAL_QUOTES + n_quotes
    
}
```

or using `purrr`-style programming: 

```{r}
library(httr2)
library(tidyverse)
library(rvest)

seq(N_PAGES) |>
    map(\(p) request(URL) |> req_url_path("page", p)) |>
    map(req_perform) |>
    map(resp_body_html) |>
    map(html_elements, ".quote") |>
    map_int(length) |>
    sum()
```

:::

2. How many quotes are tagged "Death"?

::: {.callout-tip title="Solution" collapse="true"}

```{r}
library(httr2)
library(tidyverse)
library(rvest)

N_DEATH_QUOTES <- 0

for(page in 1:N_PAGES){
    death_quotes <- request(URL) |>
        req_url_path("page", page) |>
        req_perform() |>
        resp_body_html() |>
        html_elements(".quote .tags") |>
        html_text2() |>
        str_detect("death") |>
        sum()
    
    N_DEATH_QUOTES <- N_DEATH_QUOTES + death_quotes
    
}

N_DEATH_QUOTES
```

or using `purrr`-style programming: 

```{r}
library(httr2)
library(tidyverse)
library(rvest)

seq(N_PAGES) |>
    map(\(p) request(URL) |> req_url_path("page", p)) |>
    map(req_perform) |>
    map(resp_body_html) |>
    map(html_elements, ".quote .tags") |>
    map(html_text2) |>
    map_int(\(x) sum(str_detect(x, "death"))) |>
    sum()
```

:::

3. How many quotes are by (or at least are attributed to) Albert Einstein?


::: {.callout-tip title="Solution" collapse="true"}

```{r}
library(httr2)
library(tidyverse)
library(rvest)

N_EINSTEIN_QUOTES <- 0

for(page in 1:N_PAGES){
    einstein_quotes <- request(URL) |>
        req_url_path("page", page) |>
        req_perform() |>
        resp_body_html() |>
        html_elements(".quote .author") |>
        html_text2() |>
        str_detect("Einstein") |>
        sum()
    
    N_EINSTEIN_QUOTES <- N_EINSTEIN_QUOTES + einstein_quotes
    
}

N_EINSTEIN_QUOTES
```

or using `purrr`-style programming: 

```{r}
library(httr2)
library(tidyverse)
library(rvest)

seq(N_PAGES) |>
    map(\(p) request(URL) |> req_url_path("page", p)) |>
    map(req_perform) |>
    map(resp_body_html) |>
    map(html_elements, ".quote .author") |>
    map(html_text2) |>
    map_int(\(x) sum(str_detect(x, "Einstein"))) |>
    sum()
```

:::

4. What is the longest quote (by number of characters)? The `str_length` 
   and `which.max` functions will be helpful. 
   
   You can use them like this: 
   
   ```{r}
   x <- c("short", "medium", "very quite long")
   longest <- x[which.max(str_length(x))]
   ```
   
::: {.callout-tip title="Solution" collapse="true"}

```{r}
library(httr2)
library(tidyverse)
library(rvest)

LONGEST_QUOTE <- ""

for(page in 1:N_PAGES){
    all_quotes <- request(URL) |>
        req_url_path("page", page) |>
        req_perform() |>
        resp_body_html() |>
        html_elements(".quote .text") |>
        html_text2()
        
    longest_on_page <- all_quotes[which.max(str_length(all_quotes))]
    
    if(str_length(longest_on_page) > str_length(LONGEST_QUOTE)){
        LONGEST_QUOTE <- longest_on_page
    }
}

cat("The longest quote is: ")
cat(LONGEST_QUOTE)
cat("which is ", str_length(LONGEST_QUOTE), " characters long.")
```
:::
   

5. Of all authors quoted, who has the earliest (estimated) birthday? 

   *Hint:* Use the `as.Date` function to parse these dates. *E.g.*,
   
   ```{r}
   x <- "March 14, 1879"
   as.Date(x, "%b %d, %Y")
   ```
   
   Here, the second string is a _format_ string, which specifies how the date
   is written.
   
::: {.callout-tip title="Solution" collapse="true"}


```{r}
#| cache: true
library(httr2)
library(tidyverse)
library(rvest)

ALL_AUTHOR_LINKS <- c()

for(page in 1:N_PAGES){
    author_links <- request(URL) |>
        req_url_path("page", page) |>
        req_perform() |>
        resp_body_html() |>
        html_elements(".quote a") |>
        html_attr("href") |>
        str_subset("author")
    
    ALL_AUTHOR_LINKS <- c(ALL_AUTHOR_LINKS, paste0(URL, author_links))
    
}

ALL_AUTHOR_LINKS <- unique(ALL_AUTHOR_LINKS)

AUTHORS <- map(ALL_AUTHOR_LINKS, read_html) |>
    map(\(h) data.frame(name=h |> html_element(".author-title") |> html_text2(),
                        date=h |> html_element(".author-born-date") |> html_text2())) |>
    list_rbind() |>
    mutate(date = as.Date(date, "%b %d, %Y"))

AUTHORS |> slice_min(date)
```

:::
