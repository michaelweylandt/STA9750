```{r}
#| echo: false
#| message: false
#| warning: false
library(glue)
library(rlang)
library(yaml)
library(purrr)
library(jsonlite)
library(tidyverse)

REPO_NAME <- read_yaml("_variables.yml")$course$repo
get_mp_title <- function(N){
    mp_file <- glue("mini/mini0{N}.qmd")
    mp_text <- readLines(mp_file, n=50)
    
    header_end <- which(grepl("---", mp_text))[2]
    
    header_info <- yaml.load(readLines(mp_file, n=header_end))
    
    header_info$mp_title %||% "TBD"
}


get_mp_application <- function(N){
    mp_file <- glue("mini/mini0{N}.qmd")
    mp_text <- readLines(mp_file, n=50)
    
    header_end <- which(grepl("---", mp_text))[2]
    
    header_info <- yaml.load(readLines(mp_file, n=header_end))
    
    header_info$mp_application %||% "TBD"
}


get_mp_rhetoric <- function(N){
    mp_file <- glue("mini/mini0{N}.qmd")
    mp_text <- readLines(mp_file, n=50)
    
    header_end <- which(grepl("---", mp_text))[2]
    
    header_info <- yaml.load(readLines(mp_file, n=header_end))
    
    header_info$mp_rhetoric %||% "TBD"
}


get_mp_skills <- function(N){
    mp_file <- glue("mini/mini0{N}.qmd")
    mp_text <- readLines(mp_file, n=50)
    
    header_end <- which(grepl("---", mp_text))[2]
    
    header_info <- yaml.load(readLines(mp_file, n=header_end))
    
    header_info$mp_skills %||% "TBD"
}

get_mp_assigned <- function(N){
    read_csv("key_dates.csv") |> 
        filter(`Course Element` == "Mini-Projects", 
               `Item Number`== N, 
               str_detect(Details, "Released"), 
               !str_detect(Details, "Peer")) |>
        pull(Date)
}

get_mp_deadline <- function(N, as_date_obj = FALSE){
    row <- read_csv("key_dates.csv") |> 
                filter(`Course Element` == "Mini-Projects", 
                       `Item Number`== N, 
                       str_detect(Details, "Due"), 
                      !str_detect(Details, "Peer"))
    
    if(as_date_obj) return(row |> pull(Date))
    
    row |>
        mutate(due = paste(Date, "at", Time)) |>
        pull(due)
}

get_mp_pf_assigned <- function(N){
    read_csv("key_dates.csv") |> 
        filter(`Course Element` == "Mini-Projects", 
               `Item Number`== N, 
               str_detect(Details, "Assigned"), 
               str_detect(Details, "Peer")) |>
        pull(Date)
}



get_mp_pf_deadline <- function(N){
    read_csv("key_dates.csv") |> 
        filter(`Course Element` == "Mini-Projects", 
               `Item Number`== N, 
               str_detect(Details, "Peer"), 
               str_detect(Details, "Due")) |>
        pull(Date)
}

get_pa_deadline <- function(N){
    read_csv("key_dates.csv") |> 
        filter(`Course Element` == "Pre-Assignments", 
               `Item Number`== N, 
               str_detect(Details, "Due"), 
               !str_detect(Details, "Peer")) |>
        mutate(due = paste(Date, "at", Time)) |>
        pull(due)
}

get_mp_submitted <- function(N){
    ISSUES <- read_json(glue("https://api.github.com/repos/michaelweylandt/{REPO_NAME}/issues?labels=MiniProject%20%230{N}&per_page=100&state=open"))
    
    LABELS <- ISSUES |> 
        map(pluck("labels")) |> 
        purrr::flatten() |> 
        map(pluck("name")) |> 
        list_c()
    
    N_SUBMITTED <- length(ISSUES)
    
    N_COMPLETED <- LABELS |> str_equal("Passed all automated checks") |> sum()
    N_NEED_WORK <- N_SUBMITTED - N_COMPLETED
    
    list(n_submitted = N_SUBMITTED, 
         n_completed = N_COMPLETED,
         n_need_work = N_NEED_WORK)
}

get_project_due_date <- function(element = c("individual_report", 
                                             "group_report", 
                                             "peer_evaluation", 
                                             "team_formation", 
                                             "proposal")){
    
    element <- match.arg(element)
    
    search_string = case_match(element, 
                               "team_formation" ~ "Team Roster",
                               "individual_report" ~ "Individual Report", 
                               "group_report" ~ "Summary Report",
                               "peer_evaluation" ~ "Peer Evaluation", 
                               "proposal" ~ "Project Proposal")
    
    read_csv("key_dates.csv") |> 
        filter(`Course Element` == "Course Project", 
               str_detect(Details, search_string)) |>
        pull(Date)
}

next_session <- session + 1

DATES   <- read_csv("key_dates.csv")
TODAY   <- DATES |> filter(`Course Element` == "Class Session", 
                           `Item Number` == session)

TODAY_TOPIC <- TODAY |>
    slice_head(n=1) |>
    pull(Details) 


PROJ_RELEASE <- DATES |> 
    filter(Details == "Course Project Description Released") |>
    pull(Date)

ROSTERS <- get_project_due_date("team_formation")
PROPOSALS <- get_project_due_date("proposal")


library(jsonlite)
library(yaml)

if(file.exists("roster.json")){
    
    N_TEAMS <- read_yaml("_teaching.yml")$gradedir |>
        file.path("roster.json") |> 
        read_json(simplify=TRUE) |> 
        pull(project_team) |> 
        max(na.rm=TRUE)
    
    N_ON_TEAM <- read_yaml("_teaching.yml")$gradedir |>
        file.path("roster.json") |> 
        read_json(simplify=TRUE) |> 
        filter(!is.na(project_team)) |> 
        NROW()
    
    N_NO_TEAM <- read_yaml("_teaching.yml")$gradedir |>
        file.path("roster.json") |> 
        read_json(simplify=TRUE) |> 
        filter(is.na(project_team)) |> 
        NROW()

} else {
    N_TEAMS <- N_ON_TEAM <- N_NO_TEAM <- NA
}

set.seed(9750+session)
library(yaml)
library(jsonlite)

TEAMS_FILE <- read_yaml("_teaching.yml") |> 
  pluck("gradedir") |> 
  file.path("teams.json")

if(file.exists(TEAMS_FILE)){
    TEAMS <- TEAMS_FILE |> 
       read_json(simplify=TRUE) |> 
      pull(name) |>
      sample()
} else {
    TEAMS <- "TBD"
}

BREAKOUT_TABLE <- data.frame(Team=TEAMS) |> 
  mutate(Breakout = row_number()) |> 
  select(Breakout, Team) |> 
  knitr::kable(row.names = FALSE)
```

## Today's Logistics

Today: `r TODAY_TOPIC`

These slides can be found online at: 

```{r}
#| message: false
#| echo: false
library(yaml)
url_base <- read_yaml("_variables.yml")$course$`web-url`
url_file <- sprintf("slides/slides%02g.html", session)

url_full <- paste0(url_base, url_file)
```

> [`r url_full`](`r url_full`)

In-class activities (if any) can be found at: 

```{r}
#| message: false
#| echo: false
url_base <- read_yaml("_variables.yml")$course$`web-url`
url_file <- sprintf("labs/lab%02g.html", session)

url_full <- paste0(url_base, url_file)
```

> [`r url_full`](`r url_full`)

## Upcoming TODO

Upcoming student responsibilities:

```{r}
#| message: false
library(gt)
read_csv("key_dates.csv") |>
    filter((`Responsible Party` == "Student") | (is.na(`Responsible Party`))) |>
    mutate(Time2 = Time |> str_replace("11:", "23:") |> str_replace("6:", "18:")) |>
    filter((Date > class_date) | 
           ((Date == class_date) & str_detect(Time2, "23"))) |>
    mutate(Details = case_when(
            is.na(`Item Number`) ~ Details, 
            TRUE ~ str_replace(Details, "Due", sprintf("#%02g Due", `Item Number`))
           )
    ) |>
    arrange(Date, Time2) |> 
    select(Date, Time, Details) |> 
    filter(Date <= class_date + 28) |>
    gt() |>
    tab_options(table.width = pct(100), 
                table.font.size = pct(80))
```
